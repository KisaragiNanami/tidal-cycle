---
import BlogExplorer from "@components/blog/BlogExplorer";
import Layout from "@layouts/Layout.astro";
import { getAllPostsWithShortLinks } from "@/lib/blog";

export const prerender = true;

interface Post {
  slug: string;
  title: string;
  description: string;
  categories: string[];
  tags: string[];
  words: number;
  readingMinutes: number;
  url: string;
  pubDate: string;
  coverImage: string | null;
}

const posts = await getAllPostsWithShortLinks(Astro.site!);

const blogPosts: Post[] = posts
  .map((post) => {
    const { words, readingMinutes } = post.readingStats;

    return {
      slug: post.slug,
      title: post.data.title,
      description: post.data.description,
      categories: post.data.categories ?? [],
      tags: post.data.tags ?? [],
      words,
      readingMinutes,
      url: `/blog/${post.slug}`,
      pubDate: post.data.pubDate.toISOString(),
      coverImage: post.data.image ?? null,
    };
  })
  .sort(
    (a: Post, b: Post) =>
      new Date(b.pubDate).getTime() - new Date(a.pubDate).getTime(),
  );

const filterOptions = (() => {
  const categorySet = new Set<string>();
  const tagSet = new Set<string>();

  blogPosts.forEach((post) => {
    post.categories.forEach((category) => {
      categorySet.add(category);
    });
    post.tags.forEach((tag) => {
      tagSet.add(tag);
    });
  });

  return {
    categories: Array.from(categorySet).sort((a, b) =>
      a.localeCompare(b, "zh-CN"),
    ),
    tags: Array.from(tagSet).sort((a, b) => a.localeCompare(b, "zh-CN")),
  };
})();

const pageDescription =
  "浏览所有博客文章，通过标签与分类智能筛选，快速找到你感兴趣的内容。";
---

<Layout title="博客" description={pageDescription} showHero={false}>
  <BlogExplorer client:idle posts={blogPosts} filterOptions={filterOptions} />
</Layout>
